version: 1.0.{build}
image: Visual Studio 2022

artifacts:
  - path: state.txt

init:
  - ps: |
      Write-Host "=== Init ==="
      echo "rdp=enabled" > state.txt

for:
  -
    matrix:
      only:
        - job_name: setup_vm
    build_script:
      - ps: |
          Write-Host "=== Setup VM, enable RDP ==="
          $p = ConvertTo-SecureString 'Xy!9#2025_RdpStrong*' -AsPlainText -Force
          Set-LocalUser -Name 'Administrator' -Password $p
          Enable-LocalUser -Name 'Administrator'
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name 'fDenyTSConnections' -Value 0
          Enable-NetFirewallRule -DisplayGroup 'Remote Desktop'
          if (-Not (Test-Path "C:\getscreen.exe")) {
              Invoke-WebRequest -Uri "https://getscreen.me/download/getscreen_win.exe" -OutFile "C:\getscreen.exe"
          }
          Start-Process -FilePath "C:\getscreen.exe" -ArgumentList "-install -register thanhnhan211210@gmail.com" -Wait
          Start-Process -FilePath "C:\getscreen.exe" -ArgumentList "-start"
          echo "progress=rdp_ready" > state.txt
          Write-Host "=== Setup done, keeping alive 3600s ==="
          Start-Sleep -Seconds 3600

  -
    matrix:
      only:
        - job_name: keepalive1
    build_script:
      - ps: Start-Sleep -Seconds 3600

  -
    matrix:
      only:
        - job_name: keepalive2
    build_script:
      - ps: Start-Sleep -Seconds 3600

  -
    matrix:
      only:
        - job_name: keepalive3
    build_script:
      - ps: Start-Sleep -Seconds 3600

  -
    matrix:
      only:
        - job_name: keepalive4
    build_script:
      - ps: Start-Sleep -Seconds 3600

  -
    matrix:
      only:
        - job_name: keepalive5
    build_script:
      - ps: Start-Sleep -Seconds 3600

  -
    matrix:
      only:
        - job_name: keepalive6
    build_script:
      - ps: Start-Sleep -Seconds 3600

  -
    matrix:
      only:
        - job_name: keepalive7
    build_script:
      - ps: Start-Sleep -Seconds 3600

  -
    matrix:
      only:
        - job_name: keepalive8
    build_script:
      - ps: Start-Sleep -Seconds 3600

  -
    matrix:
      only:
        - job_name: keepalive9
    build_script:
      - ps: Start-Sleep -Seconds 3600
