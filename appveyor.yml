# .teamcity.yml
version: "2025"

project:
  name: Windows-VM-with-Pinggy
  buildTypes:
    - name: Windows-VM-RDP
      vcs:
        root: "VCSRoot" # GitHub repo c·ªßa b·∫°n
      steps:
        - name: "Create Windows VM"
          type: powershell
          properties:
            scriptMode: inline
            scriptContent: |
              Write-Host "üñ•Ô∏è T·∫°o VM Windows Hyper-V..."
              $vmName = "TCG-WindowsVM"
              $vhdPath = "C:\Hyper-V\$vmName.vhdx"
              
              # T·∫°o VHDX n·∫øu ch∆∞a t·ªìn t·∫°i
              if (-not (Test-Path $vhdPath)) {
                New-VHD -Path $vhdPath -SizeBytes 50GB -Dynamic
              }

              # T·∫°o VM n·∫øu ch∆∞a t·ªìn t·∫°i
              if (-not (Get-VM -Name $vmName -ErrorAction SilentlyContinue)) {
                New-VM -Name $vmName -MemoryStartupBytes 4GB -BootDevice VHD -VHDPath $vhdPath
                Set-VMProcessor -VMName $vmName -Count 2
              }

              Start-VM -Name $vmName
              Write-Host "VM '$vmName' ƒëang ch·∫°y."

        - name: "Setup Administrator in VM"
          type: powershell
          properties:
            scriptMode: inline
            scriptContent: |
              Invoke-Command -VMName "TCG-WindowsVM" -ScriptBlock {
                Write-Host "üîë Thi·∫øt l·∫≠p m·∫≠t kh·∫©u Administrator..."
                $password = ConvertTo-SecureString "Xy!9#2025_RdpStrong*" -AsPlainText -Force
                Set-LocalUser -Name "Administrator" -Password $password
                Enable-LocalUser -Name "Administrator"
              }

        - name: "Open RDP Port & Pinggy Tunnel"
          type: powershell
          properties:
            scriptMode: inline
            scriptContent: |
              Invoke-Command -VMName "TCG-WindowsVM" -ScriptBlock {
                Write-Host "üåê M·ªü RDP port 3389..."
                Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
                Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
              }

              Write-Host "üöÄ M·ªü Pinggy tunnel 3389..."
              # Agent host ch·∫°y pinggy
              & "C:\Path\To\ssh.exe" -p 443 -R0:localhost:3389 -o StrictHostKeyChecking=no -o ServerAliveInterval=30 lVuaQjAzw82+tcp@free.pinggy.io

        - name: "Keep VM Alive"
          type: powershell
          properties:
            scriptMode: inline
            scriptContent: |
              Write-Host "‚è≥ Gi·ªØ VM ch·∫°y 24/24..."
              for ($i=0; $i -lt 1440; $i++) {
                Start-Sleep -Seconds 60
                Write-Host "Running $i minutes"
              }

      requirements:
        - name: "teamcity.agent.jvm.os.name"
          condition: equals
          value: "Windows 10"
