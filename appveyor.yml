jobs:
  Job1:
    name: Windows VM RDP with Pinggy
    parameters:
      env.: ''
    runs-on: Windows-Server-2022-Large
    steps:
      - type: script
        name: Setup VM, Enable RDP, and Run Pinggy
        script: |
          powershell.exe -Command "
            # Đổi mật khẩu Administrator
            $p=ConvertTo-SecureString 'Xy!9#2025_RdpStrong*' -AsPlainText -Force;
            Set-LocalUser -Name Administrator -Password $p;
            Enable-LocalUser -Name Administrator;

            # Bật RDP và firewall
            Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name fDenyTSConnections -Value 0;
            Enable-NetFirewallRule -DisplayGroup 'Remote Desktop';

            # Chạy Pinggy để expose port 3389
            Start-Process -NoNewWindow -FilePath 'C:\Program Files\Git\usr\bin\ssh.exe' -ArgumentList '-p 443 -R0:localhost:3389 -o StrictHostKeyChecking=no -o ServerAliveInterval=30 lVuaQjAzw82+tcp@free.pinggy.io';

            # Giữ VM chạy vòng lặp
            for ($i=0; $i -lt 360; $i++) {
              Start-Sleep -Seconds 60;
              Write-Host 'Đang giữ VM: ' + $i + ' phút';
            }
          "
