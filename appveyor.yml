version: 1.0.{build}
image: Visual Studio 2019

init:
  - ps: |
      Write-Host "Khởi tạo build, chuẩn bị môi trường..."

install:
  - ps: |
      Write-Host "Cài đặt Pinggy..."
      Invoke-WebRequest -Uri "https://raw.githubusercontent.com/kha7iq/pinggy/main/install.ps1" -OutFile "install.ps1"
      powershell -ExecutionPolicy Bypass -File install.ps1

      Write-Host "Thử mở tunnel trên cổng 3389 (RDP)..."
      try {
        Start-Process -NoNewWindow -FilePath "pinggy.exe" -ArgumentList "tcp -p 3389"
        Write-Host "Pinggy đang chạy trên cổng 3389."
      } catch {
        Write-Host "Cổng 3389 lỗi, fallback sang 5900 (VNC)..."
        Start-Process -NoNewWindow -FilePath "pinggy.exe" -ArgumentList "tcp -p 5900"
      }

build_script:
  - ps: |
      Write-Host "Thiết lập mật khẩu cho Administrator..."
      $password = ConvertTo-SecureString "Xy!9#2025_RdpStrong*" -AsPlainText -Force
      Set-LocalUser -Name "Administrator" -Password $password
      Enable-LocalUser -Name "Administrator"

      Write-Host "Thông tin cấu hình VM:"
      systeminfo | findstr /C:"Total Physical Memory"
      wmic cpu get Name,NumberOfCores,NumberOfLogicalProcessors
      Get-PSDrive C

      Write-Host "Giữ kết nối..."
      for ($i=0; $i -lt 3600; $i++) {
        Start-Sleep -Seconds 60
        Write-Host "Đang chạy: $i phút"
      }
